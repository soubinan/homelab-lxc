name: Container Image Build and Sign

on:
  push:
    branches: ["main"]
  pull_request:
    branches:
      - main
      - dev

env:
  PROJECT_URL: https://github.com/soubinan/homelab-lxc
  AUTHOR: https://github.com/soubinan

jobs:
  build:
    strategy:
      matrix:
        architecture: [amd64]
        release: ['bookworm']
    runs-on: ubuntu-latest

    steps:
      - name: Install Distrobuilder
        run: |
          sudo apt-get install debootstrap squashfs-tools
          sudo snap install distrobuilder --classic
          # sudo apt-get update -y
          # sudo apt-get install -y golang-go debootstrap rsync gpg squashfs-tools git make
          # mkdir -p $HOME/go/src/github.com/lxc/
          # cd $HOME/go/src/github.com/lxc/
          # git clone https://github.com/lxc/distrobuilder
          # cd ./distrobuilder
          # sudo make
          # cp $HOME/go/bin/distrobuilder /usr/bin/distrobuilder
          mkdir $HOME/output

      - name: Get Homarr version
        run: |
          echo "HOMARR_VERSION="$(curl -s https://raw.githubusercontent.com/ajnart/homarr/master/package.json | jq -r ".version") >> $GITHUB_ENV

      - name: Check out repository code
        uses: actions/checkout@v4

      - name: Build Image
        if: github.event_name == 'pull_request'
        run: |
          sudo distrobuilder build-lxc ${{ github.workspace }}/templates/homarr.yaml -o image.architecture=${{ matrix.architecture }} -o image.release=${{ matrix.release }} -o image.variant=cloud -o source.url="http://ftp.us.debian.org/debian" $HOME/output
          ls -lash $HOME/output

      - name: Publish Artefacts
        if: github.event_name == 'push'
        run: |
          mv $HOME/output/rootfs.tar.xz /output/homarr-$HOMARR_VERSION.rootfs.tar.xz
          mv $HOME/output/meta.tar.xz /output/homarr-$HOMARR_VERSION.meta.tar.xz

name: BunkerWeb

packages:
- ca-certificates
- gnupg2
- debian-archive-keyring

actions:
- trigger: post-files
  pongo: true
  action: |-
    #!/bin/bash
    set -eux

    curl https://nginx.org/keys/nginx_signing.key | gpg --dearmor | tee /usr/share/keyrings/nginx-archive-keyring.gpg >/dev/null
    echo "deb [signed-by=/usr/share/keyrings/nginx-archive-keyring.gpg] http://nginx.org/packages/debian `lsb_release -cs` nginx" | tee /etc/apt/sources.list.d/nginx.list

    export UI_WIZARD=1
    curl -s https://packagecloud.io/install/repositories/bunkerity/bunkerweb/script.deb.sh | bash

    apt install -y bunkerweb={{image.serial}}
    apt-mark hold nginx bunkerweb

    systemctl enable bunkerweb.service
    systemctl enable bunkerweb-ui.service
